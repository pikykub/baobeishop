<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BAOBEI SHOP - PREMIUM STORE</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        :root { --main: #ff2d55; --bg: #fff5e6; --card-bg: #ffffff; --bank: #5d2e8e; --text: #2d3436; --line: #06C755; }
        * { box-sizing: border-box; }
        body { font-family: 'Kanit', sans-serif; margin: 0; background: url('https://lh3.googleusercontent.com/d/1tgohnqPTuEtMOrhLQ_YMF7nqqQZETbsx') no-repeat center center fixed; background-size: cover; color: var(--text); overflow-x: hidden; min-height: 100vh; }

        .scrolling-news { background: #000; color: gold; padding: 8px 0; overflow: hidden; white-space: nowrap; position: relative; z-index: 2000; border-bottom: 2px solid gold; font-size: 14px; }
        .scrolling-news div { display: inline-block; padding-left: 100%; animation: marquee 20s linear infinite; }
        @keyframes marquee { 0% { transform: translate(0, 0); } 100% { transform: translate(-100%, 0); } }
        .announcement { background: rgba(34, 34, 34, 0.9); color: #fff; padding: 10px; text-align: center; font-size: 13px; font-weight: 300; position: relative; z-index: 10; }
        #snowCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; }

        .navbar { background: rgba(255, 255, 255, 0.95); padding: 10px 5%; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 15px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; backdrop-filter: blur(5px); }
        .logo { font-size: 22px; font-weight: bold; color: var(--main); cursor: pointer; text-shadow: 1px 1px 2px rgba(0,0,0,0.05); }
        .nav-right { display: flex; gap: 10px; align-items: center; }
        .btn-contact { background: #eee; color: #555; padding: 8px 15px; border-radius: 50px; text-decoration: none; font-size: 14px; font-weight: 500; transition: 0.3s; display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; }
        .btn-contact:hover { background: var(--line); color: white; transform: scale(1.1); }
        .balance-tag { background: var(--main); color: white; padding: 8px 20px; border-radius: 50px; font-weight: bold; cursor: pointer; transition: 0.3s; box-shadow: 0 4px 10px rgba(255, 45, 85, 0.3); }
        
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ */
        .cart-tag { background: #333; color: white; padding: 8px 15px; border-radius: 50px; font-weight: bold; cursor: pointer; position: relative; display: flex; align-items: center; gap: 8px; }
        .cart-count { position: absolute; top: -5px; right: -5px; background: gold; color: black; font-size: 10px; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid #fff; font-weight: bold; }
        .btn-add-cart { background: #333; color: white; border: none; width: 100%; padding: 10px; border-radius: 12px; font-weight: 500; cursor: pointer; margin-top: 5px; transition: 0.3s; font-size: 13px; }

        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏ß‡∏á‡∏•‡πâ‡∏≠‡∏™‡∏∏‡πà‡∏°‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• */
        .lucky-wheel-container { margin-top: 25px; padding: 20px; background: rgba(255,255,255,0.9); border-radius: 20px; border: 2px dashed gold; text-align: center; }
        .wheel-slots { display: flex; justify-content: center; gap: 8px; margin: 15px 0; flex-wrap: wrap; }
        .slot-item { width: 55px; height: 55px; background: #fff; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 15px; border: 2px solid #eee; transition: 0.2s; color: #333; }
        .slot-active { background: gold; border-color: orange; transform: scale(1.1); box-shadow: 0 0 15px rgba(255,215,0,0.6); }
        .btn-spin { background: linear-gradient(45deg, #FFD700, #FFA500); color: #000; border: none; padding: 12px 30px; border-radius: 50px; font-weight: bold; cursor: pointer; transition: 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .btn-spin:disabled { background: #ccc; cursor: not-allowed; opacity: 0.7; }

        .btn-admin { background: #333; color: gold; padding: 8px 15px; border-radius: 50px; font-size: 14px; font-weight: bold; display: none; cursor: pointer; border: none; transition: 0.3s; }
        .container { max-width: 1200px; margin: 40px auto; padding: 0 20px; position: relative; z-index: 5; }
        .title-bar { display: flex; justify-content: space-between; align-items: center; border-left: 6px solid var(--main); padding-left: 15px; margin-bottom: 35px; background: rgba(255, 255, 255, 0.85); border-radius: 0 10px 10px 0; box-shadow: 2px 2px 10px rgba(0,0,0,0.05); padding-right: 15px; }

        .banner-container { width: 100%; margin-bottom: 30px; border-radius: 20px; overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.15); }
        .banner-img { width: 100%; height: auto; display: block; object-fit: cover; }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 30px; }
        .stat-box { background: rgba(26, 26, 26, 0.85); color: white; padding: 20px; border-radius: 15px; display: flex; flex-direction: column; text-align: center; backdrop-filter: blur(5px); }
        .stat-value { font-size: 24px; font-weight: bold; }

        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 25px; }
        .product-card { background: rgba(255,255,255,0.9); border-radius: 20px; overflow: hidden; box-shadow: 0 5px 20px rgba(0,0,0,0.1); transition: 0.4s; position: relative; border: 1px solid rgba(255,255,255,0.5); backdrop-filter: blur(10px); }
        .stock-tag { position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.7); color: white; padding: 5px 12px; border-radius: 50px; font-size: 11px; font-weight: bold; }
        .product-img { width: 100%; height: 200px; object-fit: contain; padding: 20px; transition: 0.3s; }
        .product-info { padding: 20px; text-align: center; border-top: 1px solid #f1f1f1; background: #fff; }
        .product-price { color: var(--main); font-size: 22px; font-weight: 700; margin-bottom: 15px; }
        .btn-buy { background: var(--main); color: white; border: none; width: 100%; padding: 12px; border-radius: 12px; font-weight: bold; cursor: pointer; transition: 0.3s; }

        .hidden { display: none !important; }
        .topup-card { background: rgba(255,255,255,0.95); padding: 30px; border-radius: 25px; text-align: center; max-width: 500px; margin: 0 auto; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        #loginPage, #registerPage { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 3000; backdrop-filter: blur(8px); }
        .login-card { background: white; padding: 40px; border-radius: 25px; width: 90%; max-width: 400px; text-align: center; }
        .login-input { width: 100%; padding: 15px; margin: 10px 0; border: 2px solid #eee; border-radius: 12px; font-family: 'Kanit'; outline: none; }

        .chat-widget { position: fixed; bottom: 100px; right: 30px; width: 320px; height: 450px; background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: flex; flex-direction: column; overflow: hidden; z-index: 2500; transition: 0.4s; transform: translateY(20px) scale(0.9); opacity: 0; pointer-events: none; }
        .chat-widget.active { transform: translateY(0) scale(1); opacity: 1; pointer-events: auto; }
        .chat-header { background: var(--main); color: white; padding: 15px; font-weight: bold; display: flex; justify-content: space-between; }
        .chat-tabs { display: flex; border-bottom: 1px solid #eee; background: #f8f9fa; }
        .chat-tab { flex: 1; padding: 10px; text-align: center; font-size: 13px; cursor: pointer; color: #999; }
        .chat-tab.active { color: var(--main); font-weight: bold; border-bottom: 2px solid var(--main); background: #fff; }
        .chat-messages { flex: 1; padding: 15px; overflow-y: auto; background: #f9f9f9; display: flex; flex-direction: column; }
        .msg { margin-bottom: 10px; padding: 8px 12px; border-radius: 15px; max-width: 80%; line-height: 1.4; word-break: break-all; }
        .msg-admin { background: #e0e0e0; align-self: flex-start; }
        .msg-user { background: var(--main); color: white; align-self: flex-end; }
        .floating-chat { position: fixed; bottom: 30px; right: 30px; background: var(--line); color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; cursor: pointer; z-index: 2000; }

        .qr-section { background: #f8f9fa; padding: 15px; border-radius: 15px; margin-bottom: 20px; border: 2px dashed #ddd; }
        .slip-preview { width: 100px; height: 100px; object-fit: cover; border-radius: 10px; margin: 10px auto; border: 1px solid #ccc; display: none; }
    </style>
</head>
<body>
    <div class="scrolling-news">
        <div>‚ú® BAOBEI SHOP ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö! ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏•‡∏á‡πÄ‡∏û‡∏µ‡∏¢‡∏ö! | üî• ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ: ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏∏‡πâ‡∏ô‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÉ‡∏´‡∏ç‡πà! | ‚ö†Ô∏è ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏°‡∏¥‡∏à‡∏â‡∏≤‡∏ä‡∏µ‡∏û ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÉ‡∏ä‡πâ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ä‡∏∑‡πà‡∏≠ ‡∏à‡∏¥‡∏ï‡∏£‡∏≤‡∏†‡∏£‡∏ì‡πå ‡∏à‡∏±‡∏ô‡∏ó‡∏£ ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô! ‚ú®</div>
    </div>
    <canvas id="snowCanvas"></canvas>

    <div id="registerPage" class="hidden">
        <div class="login-card">
            <h2 style="color: var(--main);">CREATE ACCOUNT</h2>
            <input type="text" id="regUsername" class="login-input" placeholder="‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ">
            <input type="password" id="regPassword" class="login-input" placeholder="‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
            <button class="btn-buy" onclick="handleRegister()">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
            <p style="font-size: 14px; margin-top: 15px;">‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß? <a href="#" onclick="toggleAuth('login')" style="color: var(--main); text-decoration: none;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</a></p>
        </div>
    </div>

    <div id="loginPage">
        <div class="login-card">
            <h2 style="color: var(--main);">BAOBEI LOGIN</h2>
            <input type="text" id="loginUsername" class="login-input" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ">
            <input type="password" id="loginPassword" class="login-input" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
            <button class="btn-buy" onclick="handleLogin()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            <p style="font-size: 14px; margin-top: 15px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ? <a href="#" onclick="toggleAuth('register')" style="color: var(--main); text-decoration: none;">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</a></p>
        </div>
    </div>

    <div id="shopContent" class="hidden">
        <div class="announcement">‚ú® ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà BAOBEI SHOP | ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏î‡∏π‡πÅ‡∏• 24 ‡∏ä‡∏°. ‚ú®</div>
        <nav class="navbar">
            <div class="logo" onclick="showPage('home')">BAOBEI SHOP</div>
            <div class="nav-right">
                <div class="cart-tag" onclick="showCart()">
                    <i class="fas fa-shopping-cart"></i> 
                    <span class="cart-count" id="cartCount">0</span>
                </div>
                <button id="adminBtn" class="btn-admin" onclick="openAdminPanel()">
                    <i class="fas fa-user-shield"></i>
                </button>
                <div class="balance-tag" onclick="showPage('topup')">
                    <i class="fas fa-wallet"></i> <span id="balanceDisplay">0</span> ‡∏ø
                </div>
                <a href="#" onclick="handleLogout()" class="btn-contact"><i class="fas fa-sign-out-alt"></i></a>
            </div>
        </nav>

        <div class="container">
            <div id="homePage">
                <div class="banner-container"><img src="https://lh3.googleusercontent.com/d/1ALVIB9eXw_BXz1By7UBemWyY_0Gp-YoF" class="banner-img"></div>
                <div class="stats-grid">
                    <div class="stat-box"><div class="stat-label">‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div><div class="stat-value" id="statStock">0</div></div>
                    <div class="stat-box"><div class="stat-label">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏™‡∏∞‡∏™‡∏°</div><div class="stat-value" id="statSalesTotal">1089</div></div>
                </div>
                <div class="title-bar">
                    <h2><i class="fas fa-shopping-bag"></i> ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</h2>
                    <button class="btn-history" style="background:#333; color:#fff; border:none; padding:8px 15px; border-radius:10px; cursor:pointer;" onclick="showOrderHistory()"><i class="fas fa-history"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
                </div>
                <div id="productList" class="product-grid"></div>
            </div>

            <div id="topupPage" class="hidden">
                <div class="topup-card">
                    <h3><i class="fas fa-university"></i> ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</h3>
                    <div class="qr-section">
                        <p>KKP: <b>201-201-9014</b> | Wallet: <b>080-920-0932</b></p>
                        <p>‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: ‡∏à‡∏¥‡∏ï‡∏£‡∏≤‡∏†‡∏£‡∏ì‡πå ‡∏à‡∏±‡∏ô‡∏ó‡∏£</p>
                        <img src="https://lh3.googleusercontent.com/d/1ardGOoNH5cU-qLoTaZ7VHLs8kUCriNmX" style="width:150px; margin-top:10px;">
                    </div>
                    <input type="number" id="topupAmount" class="login-input" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏≠‡∏ô">
                    <input type="file" id="slipInput" accept="image/*" class="hidden" onchange="previewSlip(this)">
                    <label for="slipInput" style="display:block; background:#eee; padding:10px; border-radius:10px; margin:10px 0; cursor:pointer;">‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ</label>
                    <img id="slipPreviewImg" class="slip-preview">
                    <button class="btn-buy" onclick="submitTopup()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÇ‡∏≠‡∏ô</button>

                    <div class="lucky-wheel-container">
                        <h4 style="margin:0; color:#d4af37;"><i class="fas fa-star"></i> BAOBEI LUCKY SPIN</h4>
                        <div style="font-size:13px; color:#666; margin:5px 0;">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏™‡∏∏‡πà‡∏°: <span id="spinCount" style="color:var(--main); font-weight:bold;">0</span> ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
                        <div class="wheel-slots" id="wheelSlots">
                            <div class="slot-item">1‡∏ø</div>
                            <div class="slot-item">5‡∏ø</div>
                            <div class="slot-item">10‡∏ø</div>
                            <div class="slot-item">20‡∏ø</div>
                            <div class="slot-item">50‡∏ø</div>
                        </div>
                        <button class="btn-spin" id="spinBtn" onclick="runLuckySpin()" disabled>‡∏Å‡∏î‡∏™‡∏∏‡πà‡∏°‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</button>
                        <p style="font-size:10px; color:#999; margin-top:8px;">*‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡∏£‡∏ö 50 ‡∏ö‡∏≤‡∏ó ‡∏£‡∏±‡∏ö 1 ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</p>
                    </div>
                    
                    <p onclick="showPage('home')" style="cursor:pointer; color:#999; margin-top:15px;"><i class="fas fa-chevron-left"></i> ‡∏Å‡∏•‡∏±‡∏ö</p>
                </div>
            </div>
        </div>
    </div>

    <div class="chat-widget" id="chatBox">
        <div class="chat-header"><span><i class="fas fa-comments"></i> Global Chat</span><i class="fas fa-times" onclick="toggleWebChat()"></i></div>
        <div class="chat-tabs">
            <div id="tabGlobal" class="chat-tab active" onclick="setChatMode('global')">‡πÅ‡∏ä‡∏ó‡∏£‡∏ß‡∏°</div>
            <div id="tabPrivate" class="chat-tab" onclick="setChatMode('private')">‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</div>
        </div>
        <div class="chat-messages" id="chatMessages"></div>
        <div style="padding:10px; display:flex; gap:5px; background:#fff;">
            <input type="text" id="chatInput" style="flex:1; border:1px solid #ddd; padding:8px; border-radius:20px;" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°...">
            <button onclick="sendChat()" style="background:var(--main); color:#fff; border:none; width:35px; height:35px; border-radius:50%;"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>
    <div class="floating-chat" onclick="toggleWebChat()"><i class="fas fa-comment-dots"></i></div>

    <script>
        const PRODUCTS = [
            { id: 1, name: "email(‡∏ô‡∏≠‡∏Å) ‡∏ï‡∏¥‡∏î‡∏™‡∏¥‡∏ó", price: 10, image: "https://lh3.googleusercontent.com/d/1JdUzWjV-sWQkS6vHCekLb7HN9Uc6g4J7" },
            { id: 2, name: "email(‡∏ô‡∏≠‡∏Å) ‡πÇ‡∏ô‡πÄ‡πÄ‡∏û‡∏Ñ", price: 12, image: "https://lh3.googleusercontent.com/d/1JdUzWjV-sWQkS6vHCekLb7HN9Uc6g4J7" },
            { id: 3, name: "emailThai ‡∏ï‡∏¥‡∏î‡∏™‡∏¥‡∏ó", price: 15, image: "https://lh3.googleusercontent.com/d/1JdUzWjV-sWQkS6vHCekLb7HN9Uc6g4J7" },
            { id: 4, name: "emailThai ‡πÇ‡∏ô‡πÅ‡∏û‡∏Ñ", price: 18, image: "https://lh3.googleusercontent.com/d/1JdUzWjV-sWQkS6vHCekLb7HN9Uc6g4J7" }
        ];

        let state = {
            users: JSON.parse(localStorage.getItem('baobei_users')) || {},
            inventory: JSON.parse(localStorage.getItem('baobei_inv')) || { 1: [], 2: [], 3: [], 4: [] },
            topupRequests: JSON.parse(localStorage.getItem('baobei_requests')) || [],
            usedSlips: JSON.parse(localStorage.getItem('baobei_used_slips')) || [],
            salesCount: parseInt(localStorage.getItem('baobei_sales')) || 1089,
            totalTopupSum: parseFloat(localStorage.getItem('baobei_total_topup')) || 0,
            currentUser: null,
            isAdmin: false,
            globalMessages: JSON.parse(localStorage.getItem('baobei_global_chat')) || [],
            privateMessages: JSON.parse(localStorage.getItem('baobei_private_chat')) || {},
            chatMode: 'global',
            cart: []
        };

        function persist() {
            localStorage.setItem('baobei_users', JSON.stringify(state.users));
            localStorage.setItem('baobei_inv', JSON.stringify(state.inventory));
            localStorage.setItem('baobei_requests', JSON.stringify(state.topupRequests));
            localStorage.setItem('baobei_used_slips', JSON.stringify(state.usedSlips));
            localStorage.setItem('baobei_sales', state.salesCount);
            localStorage.setItem('baobei_total_topup', state.totalTopupSum);
            localStorage.setItem('baobei_global_chat', JSON.stringify(state.globalMessages));
            localStorage.setItem('baobei_private_chat', JSON.stringify(state.privateMessages));
        }

        function updateUI() {
            if (state.currentUser && state.users[state.currentUser]) {
                document.getElementById('balanceDisplay').innerText = state.users[state.currentUser].balance.toLocaleString();
                updateSpinUI();
            }
            document.getElementById('statSalesTotal').innerText = state.salesCount;
            document.getElementById('statStock').innerText = Object.values(state.inventory).reduce((a, b) => a + b.length, 0);
            
            const list = document.getElementById('productList');
            list.innerHTML = PRODUCTS.map(p => {
                const stock = state.inventory[p.id]?.length || 0;
                return `
                <div class="product-card">
                    <div class="stock-tag">‡∏™‡∏ï‡πá‡∏≠‡∏Å: ${stock}</div>
                    <img src="${p.image}" class="product-img">
                    <div class="product-info">
                        <div style="font-weight:500; height:40px;">${p.name}</div>
                        <div class="product-price">${p.price} ‡∏ø</div>
                        <button class="btn-buy" onclick="buyProduct(${p.id})" ${stock === 0 && !state.isAdmin ? 'disabled' : ''}>‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</button>
                        <button class="btn-add-cart" onclick="addToCart(${p.id})" ${stock === 0 ? 'style="display:none"' : ''}>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</button>
                    </div>
                </div>`;
            }).join('');
            updateCartBadge();
            renderChat();
        }

        /* ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ */
        function addToCart(id) {
            const p = PRODUCTS.find(item => item.id === id);
            const stock = state.inventory[id]?.length || 0;
            const itemInCart = state.cart.find(i => i.id === id);
            if (stock > (itemInCart ? itemInCart.qty : 0)) {
                if (itemInCart) itemInCart.qty++;
                else state.cart.push({ id: id, name: p.name, price: p.price, qty: 1 });
                updateCartBadge();
                Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß', showConfirmButton: false, timer: 1000 });
            } else Swal.fire('‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏≠', '', 'warning');
        }

        function updateCartBadge() {
            document.getElementById('cartCount').innerText = state.cart.reduce((sum, i) => sum + i.qty, 0);
        }

        function showCart() {
            if (state.cart.length === 0) return Swal.fire('‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á', '', 'info');
            let total = 0;
            let html = state.cart.map((item, index) => {
                total += item.price * item.qty;
                return `<div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <span>${item.name} (${item.qty})</span>
                    <b>${item.price * item.qty}‡∏ø <i class="fas fa-trash" style="color:red; cursor:pointer;" onclick="state.cart.splice(${index},1); showCart(); updateCartBadge();"></i></b>
                </div>`;
            }).join('');
            Swal.fire({
                title: '‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤',
                html: html + `<hr><h3 style="text-align:right">‡∏£‡∏ß‡∏°: ${total} ‡∏ø</h3>`,
                showCancelButton: true,
                confirmButtonText: '‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô'
            }).then(r => { if(r.isConfirmed) processBulkBuy(total); });
        }

        function processBulkBuy(totalPrice) {
            const user = state.users[state.currentUser];
            if (user.balance < totalPrice) return Swal.fire('‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠', '', 'error').then(() => showPage('topup'));
            user.balance -= totalPrice;
            let codes = [];
            state.cart.forEach(item => {
                for(let i=0; i<item.qty; i++) {
                    const code = state.inventory[item.id].pop();
                    codes.push(code);
                    user.orders.unshift({ name: item.name, code: code, date: new Date().toLocaleString() });
                    state.salesCount++;
                }
            });
            state.cart = [];
            persist(); updateUI();
            Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠', 'success');
        }

        /* ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∏‡πà‡∏°‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• */
        function updateSpinUI() {
            const user = state.users[state.currentUser];
            document.getElementById('spinCount').innerText = user.spins || 0;
            document.getElementById('spinBtn').disabled = (user.spins || 0) <= 0;
        }

        function runLuckySpin() {
            const user = state.users[state.currentUser];
            if (!user.spins || user.spins <= 0) return;
            user.spins--;
            updateSpinUI();
            const rewards = [1, 5, 10, 20, 50];
            const slots = document.querySelectorAll('.slot-item');
            let pos = 0, rounds = 0, totalRounds = 20 + Math.floor(Math.random()*10);
            let timer = setInterval(() => {
                slots.forEach(s => s.classList.remove('slot-active'));
                slots[pos % slots.length].classList.add('slot-active');
                pos++; rounds++;
                if (rounds > totalRounds) {
                    clearInterval(timer);
                    const win = rewards[(pos-1) % slots.length];
                    user.balance += win;
                    persist(); updateUI();
                    Swal.fire('‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢!', `‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏ü‡∏£‡∏µ ${win} ‡∏ø`, 'success');
                }
            }, 100);
        }

        /* ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô */
        function toggleAuth(type) {
            document.getElementById('loginPage').classList.toggle('hidden', type !== 'login');
            document.getElementById('registerPage').classList.toggle('hidden', type !== 'register');
        }

        function handleRegister() {
            const u = document.getElementById('regUsername').value.trim();
            const p = document.getElementById('regPassword').value.trim();
            if(!u || !p) return Swal.fire('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '', 'warning');
            if(state.users[u]) return Swal.fire('‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡πÅ‡∏•‡πâ‡∏ß', '', 'error');
            state.users[u] = { password: p, balance: 0, orders: [], spins: 0 };
            persist(); Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '', 'success').then(() => toggleAuth('login'));
        }

        function handleLogin() {
            const u = document.getElementById('loginUsername').value.trim();
            const p = document.getElementById('loginPassword').value.trim();
            if(u === 'admin' && p === 'admin123') { state.currentUser = "Admin"; state.isAdmin = true; }
            else if(state.users[u] && state.users[u].password === p) { state.currentUser = u; state.isAdmin = false; }
            else return Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '', 'error');
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('shopContent').classList.remove('hidden');
            if(state.isAdmin) document.getElementById('adminBtn').style.display = "block";
            updateUI();
        }

        function previewSlip(i) {
            if (i.files && i.files[0]) {
                const r = new FileReader();
                r.onload = (e) => { const img = document.getElementById('slipPreviewImg'); img.src = e.target.result; img.style.display = 'block'; };
                r.readAsDataURL(i.files[0]);
            }
        }

        function submitTopup() {
            const amt = parseFloat(document.getElementById('topupAmount').value);
            const slip = document.getElementById('slipPreviewImg').src;
            if(!amt || amt <= 0 || !slip) return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '', 'warning');
            
            const user = state.users[state.currentUser];
            user.balance += amt;
            state.totalTopupSum += amt;
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏™‡∏∏‡πà‡∏°‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• (50 ‡∏ö‡∏≤‡∏ó = 1 ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå)
            const newSpins = Math.floor(amt / 50);
            user.spins = (user.spins || 0) + newSpins;

            state.topupRequests.push({ user: state.currentUser, amount: amt, time: new Date().toLocaleString() });
            persist(); updateUI();
            Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', `‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô ${amt} ‡∏ø ${newSpins > 0 ? '‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏ö '+newSpins+' ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏™‡∏∏‡πà‡∏°‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•!' : ''}`, 'success').then(() => showPage('home'));
        }

        function buyProduct(id) {
            const p = PRODUCTS.find(i => i.id === id);
            const user = state.users[state.currentUser];
            if(user.balance < p.price) return Swal.fire('‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠', '', 'warning').then(() => showPage('topup'));
            if(state.inventory[id].length > 0) {
                const code = state.inventory[id].pop();
                user.balance -= p.price;
                user.orders.unshift({ name: p.name, code: code, date: new Date().toLocaleString() });
                state.salesCount++;
                persist(); updateUI();
                Swal.fire('‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', `CODE: ${code}`, 'success');
            } else Swal.fire('‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î', '', 'error');
        }

        function showOrderHistory() {
            const orders = state.users[state.currentUser].orders;
            if(!orders.length) return Swal.fire('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥', '', 'info');
            Swal.fire({
                title: '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠',
                html: `<div style="max-height:300px; overflow-y:auto; text-align:left;">${orders.map(o => `<div style="border-bottom:1px solid #eee; padding:5px;"><b>${o.name}</b><br><small>${o.date}</small><br><code style="background:#eee;">${o.code}</code></div>`).join('')}</div>`
            });
        }

        function showPage(p) {
            document.getElementById('homePage').classList.toggle('hidden', p !== 'home');
            document.getElementById('topupPage').classList.toggle('hidden', p !== 'topup');
        }

        function toggleWebChat() { document.getElementById('chatBox').classList.toggle('active'); }
        function setChatMode(m) { state.chatMode = m; renderChat(); }
        function sendChat() {
            const inp = document.getElementById('chatInput');
            if(!inp.value.trim()) return;
            state.globalMessages.push({ sender: state.currentUser, text: inp.value });
            persist(); renderChat(); inp.value = "";
        }
        function renderChat() {
            const box = document.getElementById('chatMessages'); box.innerHTML = "";
            state.globalMessages.slice(-20).forEach(m => {
                const d = document.createElement('div');
                d.className = `msg ${m.sender === state.currentUser ? 'msg-user' : 'msg-admin'}`;
                d.innerHTML = `<small style="display:block; font-size:9px;">${m.sender}</small>${m.text}`;
                box.appendChild(d);
            });
            box.scrollTop = box.scrollHeight;
        }

        function handleLogout() { location.reload(); }

        /* Snow effect */
        const canvas = document.getElementById('snowCanvas');
        const ctx = canvas.getContext('2d');
        let width = window.innerWidth, height = window.innerHeight;
        canvas.width = width; canvas.height = height;
        let flakes = Array.from({length: 50}, () => ({ x: Math.random()*width, y: Math.random()*height, r: Math.random()*3+1, d: Math.random()*1+0.5 }));
        function drawSnow() {
            ctx.clearRect(0,0,width,height);
            ctx.fillStyle = "rgba(255,255,255,0.6)";
            ctx.beginPath();
            flakes.forEach(f => { ctx.moveTo(f.x, f.y); ctx.arc(f.x, f.y, f.r, 0, Math.PI*2); f.y += f.d; if(f.y > height) f.y = -5; });
            ctx.fill(); requestAnimationFrame(drawSnow);
        }
        drawSnow();
        updateUI();
    </script>
</body>
</html>
