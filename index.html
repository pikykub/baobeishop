<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BAOBEI SHOP - PREMIUM STORE</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

    <style>
        :root { --main: #ff2d55; --bg: #fff5e6; --card-bg: #ffffff; --bank: #5d2e8e; --text: #2d3436; --line: #06C755; }
        * { box-sizing: border-box; }
        body { font-family: 'Kanit', sans-serif; margin: 0; background-color: #f8f9fa; color: var(--text); overflow-x: hidden; min-height: 100vh; }
        
        /* Navbar */
        .navbar { background: rgba(255, 255, 255, 0.95); padding: 10px 5%; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 15px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
        .logo { font-size: 22px; font-weight: bold; color: var(--main); cursor: pointer; }
        .nav-right { display: flex; gap: 10px; align-items: center; }
        
        .user-profile-btn { display: flex; align-items: center; gap: 8px; cursor: pointer; background: #f8f9fa; padding: 5px 12px; border-radius: 50px; border: 1px solid #eee; }
        .nav-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 2px solid var(--main); }

        /* Content */
        .container { max-width: 1200px; margin: 20px auto; padding: 0 20px; }
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; }
        .product-card { background: white; border-radius: 20px; padding: 15px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.05); transition: 0.3s; }
        .product-card:hover { transform: translateY(-5px); }
        .product-img { width: 100%; height: 160px; object-fit: contain; margin-bottom: 10px; }
        
        /* Chat Widget */
        .chat-widget { position: fixed; bottom: 100px; right: 20px; width: 320px; height: 450px; background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: flex; flex-direction: column; overflow: hidden; z-index: 2500; display: none; }
        .chat-widget.active { display: flex; }
        .chat-header { background: var(--main); color: white; padding: 15px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .chat-tabs { display: flex; background: #f1f1f1; }
        .chat-tab { flex: 1; padding: 10px; text-align: center; cursor: pointer; font-size: 13px; }
        .chat-tab.active { background: white; font-weight: bold; color: var(--main); }
        .chat-messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; background: #f9f9f9; }
        
        .msg { padding: 8px 12px; border-radius: 15px; max-width: 80%; font-size: 14px; position: relative; }
        .msg-user { background: var(--main); color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .msg-admin { background: #eee; color: #333; align-self: flex-start; border-bottom-left-radius: 2px; }
        .msg-name { font-size: 10px; margin-bottom: 2px; display: block; opacity: 0.7; }

        .floating-chat { position: fixed; bottom: 25px; right: 25px; background: var(--line); color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; cursor: pointer; z-index: 2000; box-shadow: 0 5px 15px rgba(6,199,85,0.4); }

        .btn-buy { background: var(--main); color: white; border: none; padding: 12px; border-radius: 12px; width: 100%; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-buy:hover { opacity: 0.9; }
        .hidden { display: none !important; }

        /* Login */
        #loginPage { position: fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:5000; display:flex; align-items:center; justify-content:center; }
        .login-card { width: 90%; max-width: 400px; padding: 40px; text-align: center; border-radius: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
        .login-input { width: 100%; padding: 15px; margin: 10px 0; border: 1px solid #ddd; border-radius: 12px; outline: none; }
    </style>
</head>
<body>

    <div id="loginPage">
        <div class="login-card">
            <h2 style="color: var(--main);">BAOBEI SHOP</h2>
            <input type="text" id="loginUsername" class="login-input" placeholder="ชื่อผู้ใช้">
            <input type="password" id="loginPassword" class="login-input" placeholder="รหัสผ่าน">
            <button class="btn-buy" onclick="handleLogin()">เข้าสู่ระบบ</button>
            <p style="font-size: 12px; color: #999; margin-top: 15px;">Admin: admin / yongchai07</p>
        </div>
    </div>

    <div id="shopContent" class="hidden">
        <nav class="navbar">
            <div class="logo" onclick="showPage('home')">BAOBEI SHOP</div>
            <div class="nav-right">
                <div class="user-profile-btn" onclick="openEditProfile()">
                    <img id="navAvatarImg" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" class="nav-avatar">
                    <span id="navNickname">User</span>
                </div>
                <div style="font-weight: bold; color: var(--main);"><i class="fas fa-wallet"></i> <span id="balanceDisplay">0</span> ฿</div>
                <button onclick="openAdminPanel()" id="adminBtn" class="hidden" style="background:#333; color:gold; border:none; padding:5px 10px; border-radius:8px; cursor:pointer;">Admin</button>
            </div>
        </nav>

        <div class="container">
            <div id="homePage">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h3>สินค้าทั้งหมด</h3>
                    <button onclick="showPage('topup')" class="btn-buy" style="width:auto; padding:8px 20px;">เติมเงิน</button>
                </div>
                <div id="productList" class="product-grid"></div>
            </div>

            <div id="topupPage" class="hidden">
                <div class="login-card" style="margin: 0 auto; box-shadow: none; border: 1px solid #eee;">
                    <h3>แจ้งเติมเงิน</h3>
                    <div style="background:#f4f7ff; padding:15px; border-radius:15px; margin-bottom:15px; text-align:left;">
                        <p style="margin:5px 0; font-size:14px;"><b>ธนาคาร:</b> เกียรตินาคินภัทร (KKP)</p>
                        <p style="margin:5px 0; font-size:14px;"><b>เลขบัญชี:</b> 201-201-9014</p>
                        <p style="margin:5px 0; font-size:14px;"><b>ชื่อ:</b> จิตราภรณ์ จันทร</p>
                    </div>
                    <input type="number" id="topupAmount" class="login-input" placeholder="จำนวนเงิน">
                    <input type="file" id="slipInput" accept="image/*" class="hidden" onchange="previewSlip(this)">
                    <label for="slipInput" style="display:block; background:#eee; padding:15px; border-radius:12px; cursor:pointer; margin-bottom:10px;">
                        <i class="fas fa-image"></i> เลือกรูปสลิปจากมือถือ
                    </label>
                    <img id="slipPreviewImg" style="width:100%; border-radius:10px; margin-bottom:10px; display:none;">
                    <button class="btn-buy" onclick="submitTopup()">ยืนยันแจ้งโอน</button>
                    <button onclick="showPage('home')" style="background:none; border:none; color:#999; margin-top:10px; cursor:pointer;">ย้อนกลับ</button>
                </div>
            </div>
        </div>
    </div>

    <div class="chat-widget" id="chatBox">
        <div class="chat-header">
            <span id="chatTitle">Global Chat</span>
            <i class="fas fa-times" onclick="toggleWebChat()" style="cursor:pointer;"></i>
        </div>
        <div class="chat-tabs">
            <div id="tabGlobal" class="chat-tab active" onclick="setChatMode('global')">แชทรวม</div>
            <div id="tabPrivate" class="chat-tab" onclick="setChatMode('private')">แชทส่วนตัว</div>
        </div>
        <div class="chat-messages" id="chatMessages"></div>
        <div style="padding:10px; display:flex; gap:5px; border-top:1px solid #eee;">
            <input type="text" id="chatInput" style="flex:1; padding:10px; border-radius:20px; border:1px solid #ddd; outline:none;" placeholder="พิมพ์ข้อความ...">
            <button onclick="sendChat()" style="background:var(--main); color:white; border:none; border-radius:50%; width:40px; height:40px;"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>
    <div class="floating-chat" onclick="toggleWebChat()"><i class="fas fa-comment-dots"></i></div>

    <script>
        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyA_LlV9fGkchscbzFmxqNMrKvK_Nznk0mM",
            authDomain: "baobei-shop-chat.firebaseapp.com",
            databaseURL: "https://baobei-shop-chat-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "baobei-shop-chat",
            storageBucket: "baobei-shop-chat.appspot.com",
            messagingSenderId: "878710791654",
            appId: "1:878710791654:web:818c275893b85042e70a27"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let state = {
            currentUser: null,
            isAdmin: false,
            activePrivateUser: null, // สำหรับแอดมินเลือกคุย
            chatMode: 'global',
            users: JSON.parse(localStorage.getItem('bb_users')) || {}
        };

        const PRODUCTS = [
            { id: 1, name: "email(นอก) ติดสิท", price: 10, img: "https://cdn-icons-png.flaticon.com/512/281/281769.png" },
            { id: 2, name: "email(นอก) โนเเพค", price: 12, img: "https://cdn-icons-png.flaticon.com/512/281/281769.png" },
            { id: 3, name: "emailThai ติดสิท", price: 15, img: "https://cdn-icons-png.flaticon.com/512/732/732200.png" },
            { id: 4, name: "emailThai โนแพค", price: 18, img: "https://cdn-icons-png.flaticon.com/512/732/732200.png" }
        ];

        // --- Auth ---
        function handleLogin() {
            const u = document.getElementById('loginUsername').value.trim();
            const p = document.getElementById('loginPassword').value.trim();
            if(u === 'admin' && p === 'yongchai07') {
                state.currentUser = 'Admin'; state.isAdmin = true;
            } else if(u && p) {
                if(!state.users[u]) state.users[u] = { password: p, balance: 0, nickname: u, avatar: "" };
                if(state.users[u].password !== p) return Swal.fire('ผิดพลาด', 'รหัสผ่านไม่ถูกต้อง', 'error');
                state.currentUser = u; state.isAdmin = false;
            } else { return; }
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('shopContent').classList.remove('hidden');
            if(state.isAdmin) document.getElementById('adminBtn').classList.remove('hidden');
            initUI();
            setChatMode('global');
        }

        function initUI() {
            const user = state.isAdmin ? { nickname: "Admin", balance: 9999, avatar: "" } : state.users[state.currentUser];
            document.getElementById('navNickname').innerText = user.nickname || state.currentUser;
            document.getElementById('balanceDisplay').innerText = (user.balance || 0).toLocaleString();
            if(user.avatar) document.getElementById('navAvatarImg').src = user.avatar;

            document.getElementById('productList').innerHTML = PRODUCTS.map(p => `
                <div class="product-card">
                    <img src="${p.img}" class="product-img">
                    <h4 style="margin:10px 0;">${p.name}</h4>
                    <p style="color:var(--main); font-weight:bold; font-size:18px; margin-bottom:10px;">${p.price} ฿</p>
                    <button class="btn-buy" onclick="Swal.fire('สำเร็จ','ซื้อสินค้าเรียบร้อย','success')">ซื้อสินค้า</button>
                </div>
            `).join('');
        }

        // --- โปรไฟล์ & อัลบั้มมือถือ (Base64) ---
        async function openEditProfile() {
            if(state.isAdmin) return;
            const user = state.users[state.currentUser];
            const { value: formValues } = await Swal.fire({
                title: 'แก้ไขโปรไฟล์',
                html: `
                    <div style="margin-bottom:15px;">
                        <img id="swal-prev" src="${user.avatar || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'}" style="width:100px; height:100px; border-radius:50%; object-fit:cover; border:3px solid var(--main);">
                    </div>
                    <input type="file" id="swal-file" accept="image/*" class="swal2-file">
                    <input id="swal-nick" class="swal2-input" placeholder="ชื่อเล่น" value="${user.nickname || ''}">
                `,
                showCancelButton: true,
                preConfirm: async () => {
                    const file = document.getElementById('swal-file').files[0];
                    let avatarBase64 = user.avatar;
                    if(file) {
                        avatarBase64 = await new Promise(r => {
                            const reader = new FileReader();
                            reader.readAsDataURL(file);
                            reader.onload = () => r(reader.result);
                        });
                    }
                    return { nickname: document.getElementById('swal-nick').value, avatar: avatarBase64 };
                }
            });

            if(formValues) {
                state.users[state.currentUser].nickname = formValues.nickname;
                state.users[state.currentUser].avatar = formValues.avatar;
                localStorage.setItem('bb_users', JSON.stringify(state.users));
                initUI();
                Swal.fire('สำเร็จ', 'อัปเดตข้อมูลแล้ว', 'success');
            }
        }

        // --- ระบบเติมเงิน & ตรวจสลิป ---
        function previewSlip(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.getElementById('slipPreviewImg');
                    img.src = e.target.result;
                    img.style.display = 'block';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        async function submitTopup() {
            const amt = parseFloat(document.getElementById('topupAmount').value);
            const file = document.getElementById('slipInput').files[0];
            if(!amt || !file) return Swal.fire('แจ้งเตือน', 'กรุณากรอกเงินและแนบสลิป', 'warning');

            Swal.fire({ title: 'กำลังตรวจสอบสลิป...', didOpen: () => Swal.showLoading() });
            
            const slipBase64 = await new Promise(r => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => r(reader.result);
            });

            // ส่งข้อมูลแจ้งโอนไปที่ Firebase ให้แอดมินดู
            db.ref('topup_requests').push({
                user: state.currentUser,
                amount: amt,
                slip: slipBase64,
                time: Date.now()
            });

            setTimeout(() => {
                if(!state.isAdmin) {
                    state.users[state.currentUser].balance += amt;
                    localStorage.setItem('bb_users', JSON.stringify(state.users));
                }
                initUI();
                showPage('home');
                Swal.fire('สำเร็จ', 'ระบบได้รับข้อมูลการแจ้งโอนแล้ว', 'success');
            }, 1500);
        }

        // --- ระบบแชทส่วนตัว (แอดมินเลือกตอบ) ---
        function setChatMode(mode) {
            state.chatMode = mode;
            document.getElementById('tabGlobal').classList.toggle('active', mode === 'global');
            document.getElementById('tabPrivate').classList.toggle('active', mode === 'private');
            
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = "";
            
            let path = (mode === 'global') ? 'global_chat' : `private_chats/${state.isAdmin ? state.activePrivateUser : state.currentUser}`;
            
            if(mode === 'private' && state.isAdmin && !state.activePrivateUser) {
                chatMessages.innerHTML = "<p style='text-align:center; color:#999; margin-top:20px;'>กรุณาเลือกชื่อลูกค้าจากเมนู Admin</p>";
                return;
            }

            db.ref(path).off();
            db.ref(path).limitToLast(20).on('child_added', (snap) => {
                const m = snap.val();
                const isMe = m.senderId === state.currentUser;
                const msgDiv = document.createElement('div');
                msgDiv.className = `msg ${isMe ? 'msg-user' : 'msg-admin'}`;
                msgDiv.innerHTML = `<span class="msg-name">${m.sender}</span>${m.text}`;
                chatMessages.appendChild(msgDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            });
        }

        function sendChat() {
            const inp = document.getElementById('chatInput');
            if(!inp.value.trim()) return;
            
            let path = (state.chatMode === 'global') ? 'global_chat' : `private_chats/${state.isAdmin ? state.activePrivateUser : state.currentUser}`;
            
            db.ref(path).push({
                sender: state.isAdmin ? "Admin" : (state.users[state.currentUser].nickname || state.currentUser),
                senderId: state.currentUser,
                text: inp.value,
                time: Date.now()
            });
            inp.value = "";
        }

        function openAdminPanel() {
            // ดึงรายชื่อคนทักแชท
            db.ref('private_chats').once('value', (snap) => {
                const chats = snap.val() || {};
                const usersHtml = Object.keys(chats).map(uid => `
                    <button onclick="adminReplyTo('${uid}')" style="width:100%; padding:10px; margin-bottom:5px; border:1px solid #ddd; border-radius:10px; background:white; cursor:pointer; text-align:left;">
                        <i class="fas fa-user"></i> ${uid} (มีข้อความใหม่)
                    </button>
                `).join('') || "ไม่มีแชทใหม่";

                Swal.fire({
                    title: 'แผงควบคุมแอดมิน',
                    html: `<div style="text-align:left;"><h4>แชทส่วนตัวของลูกค้า:</h4>${usersHtml}</div>`,
                    showConfirmButton: false
                });
            });
        }

        window.adminReplyTo = (uid) => {
            state.activePrivateUser = uid;
            state.chatMode = 'private';
            Swal.close();
            if(!document.getElementById('chatBox').classList.contains('active')) toggleWebChat();
            setChatMode('private');
        };

        function toggleWebChat() { document.getElementById('chatBox').classList.toggle('active'); }
        function showPage(p) {
            document.getElementById('homePage').classList.toggle('hidden', p !== 'home');
            document.getElementById('topupPage').classList.toggle('hidden', p !== 'topup');
        }
    </script>
</body>
</html>
