<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BAOBEI SHOP - PREMIUM STORE</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    
    <style>
        :root { --main: #ff2d55; --bg: #fff5e6; --card-bg: #ffffff; --bank: #5d2e8e; --text: #2d3436; --line: #06C755; }
        
        * { box-sizing: border-box; }

        body { 
            font-family: 'Kanit', sans-serif; 
            margin: 0; 
            background: url('https://lh3.googleusercontent.com/d/1tgohnqPTuEtMOrhLQ_YMF7nqqQZETbsx') no-repeat center center fixed;
            background-size: cover;
            color: var(--text); 
            overflow-x: hidden; 
            min-height: 100vh;
        }

        /* 1. ‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÄ‡πÄ‡∏ö‡∏ö‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà */
        .scrolling-news { background: #000; color: gold; padding: 8px 0; overflow: hidden; white-space: nowrap; position: relative; z-index: 2000; border-bottom: 2px solid gold; font-size: 14px; }
        .scrolling-news div { display: inline-block; padding-left: 100%; animation: marquee 20s linear infinite; }
        @keyframes marquee { 0% { transform: translate(0, 0); } 100% { transform: translate(-100%, 0); } }

        .announcement { background: rgba(34, 34, 34, 0.9); color: #fff; padding: 10px; text-align: center; font-size: 13px; font-weight: 300; position: relative; z-index: 10; }
        
        #snowCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; }

        .navbar { background: rgba(255, 255, 255, 0.95); padding: 10px 5%; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 15px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; backdrop-filter: blur(5px); }
        .logo { font-size: 22px; font-weight: bold; color: var(--main); cursor: pointer; text-shadow: 1px 1px 2px rgba(0,0,0,0.05); }
        .nav-right { display: flex; gap: 10px; align-items: center; }
        
        .btn-contact { background: #eee; color: #555; padding: 8px 15px; border-radius: 50px; text-decoration: none; font-size: 14px; font-weight: 500; transition: 0.3s; display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; }
        .btn-contact:hover { background: var(--line); color: white; transform: scale(1.1); }
        
        .balance-tag { background: var(--main); color: white; padding: 8px 20px; border-radius: 50px; font-weight: bold; cursor: pointer; transition: 0.3s; box-shadow: 0 4px 10px rgba(255, 45, 85, 0.3); }
        .balance-tag:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(255, 45, 85, 0.4); }
        
        .cart-tag { background: #333; color: white; padding: 8px 15px; border-radius: 50px; font-weight: bold; cursor: pointer; position: relative; display: flex; align-items: center; gap: 8px; }
        .cart-count { position: absolute; top: -5px; right: -5px; background: gold; color: black; font-size: 10px; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid #fff; font-weight: bold; }
        .btn-add-cart { background: #333; color: white; border: none; width: 100%; padding: 10px; border-radius: 12px; font-weight: 500; cursor: pointer; margin-top: 5px; transition: 0.3s; font-size: 13px; }
        .btn-add-cart:hover { background: #000; }

        .btn-admin { background: #333; color: gold; padding: 8px 15px; border-radius: 50px; font-size: 14px; font-weight: bold; display: none; cursor: pointer; border: none; transition: 0.3s; }
        .btn-admin:hover { background: #000; color: #fff; }

        .container { max-width: 1200px; margin: 40px auto; padding: 0 20px; position: relative; z-index: 5; }
        .title-bar { display: flex; justify-content: space-between; align-items: center; border-left: 6px solid var(--main); padding-left: 15px; margin-bottom: 35px; background: rgba(255, 255, 255, 0.85); border-radius: 0 10px 10px 0; box-shadow: 2px 2px 10px rgba(0,0,0,0.05); padding-right: 15px; }

        /* ‡∏£‡∏∞‡∏ö‡∏ö Profile Settings */
        .user-profile-btn { display: flex; align-items: center; gap: 8px; cursor: pointer; background: #f8f9fa; padding: 5px 12px; border-radius: 50px; border: 1px solid #eee; transition: 0.3s; }
        .user-profile-btn:hover { background: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .nav-avatar { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; border: 2px solid var(--main); }
        .nav-nickname { font-size: 14px; font-weight: 500; color: #333; }

        /* --- ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á CSS CHAT ‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå --- */
        .chat-widget { position: fixed; bottom: 100px; right: 30px; width: 340px; height: 500px; background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: flex; flex-direction: column; overflow: hidden; z-index: 2500; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform: translateY(20px) scale(0.9); opacity: 0; pointer-events: none; }
        .chat-widget.active { transform: translateY(0) scale(1); opacity: 1; pointer-events: auto; }
        .chat-header { background: var(--main); color: white; padding: 15px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        
        .chat-tabs { display: flex; border-bottom: 1px solid #eee; background: #f8f9fa; }
        .chat-tab { flex: 1; padding: 10px; text-align: center; font-size: 13px; cursor: pointer; transition: 0.3s; color: #999; border-bottom: 2px solid transparent; }
        .chat-tab.active { color: var(--main); border-bottom: 2px solid var(--main); background: #fff; font-weight: bold; }

        .chat-messages { flex: 1; padding: 15px; overflow-y: auto; background: #f2f3f5; font-size: 14px; display: flex; flex-direction: column; gap: 15px; }
        
        /* Message Wrapper */
        .chat-row { display: flex; gap: 8px; max-width: 85%; }
        .chat-row.me { align-self: flex-end; flex-direction: row-reverse; }
        .chat-row.other { align-self: flex-start; }

        .chat-msg-avatar { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; border: 1px solid #ddd; flex-shrink: 0; cursor: pointer; }
        
        .chat-msg-body { display: flex; flex-direction: column; gap: 2px; }
        .me .chat-msg-body { align-items: flex-end; }
        
        .chat-msg-name { font-size: 11px; color: #777; font-weight: 600; padding: 0 5px; cursor: pointer; }
        .chat-msg-text { padding: 8px 12px; border-radius: 15px; position: relative; word-break: break-all; line-height: 1.4; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        
        .me .chat-msg-text { background: var(--main); color: white; border-bottom-right-radius: 2px; }
        .other .chat-msg-text { background: white; color: #333; border-bottom-left-radius: 2px; border: 1px solid #e0e0e0; }

        .badge-crown { color: #f59e0b; margin-right: 3px; font-size: 10px; }

        .floating-chat { position: fixed; bottom: 30px; right: 30px; background: var(--line); color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; cursor: pointer; z-index: 2000; box-shadow: 0 10px 25px rgba(6, 199, 85, 0.4); transition: 0.3s; }
        .floating-chat:hover { transform: rotate(15deg) scale(1.1); }
        /* --- ‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô CSS ‡πÅ‡∏ä‡∏ó‡πÉ‡∏´‡∏°‡πà --- */

        #loginPage, #registerPage { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 3000; backdrop-filter: blur(8px); }
        .login-card { background: white; padding: 40px; border-radius: 25px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); width: 90%; max-width: 400px; text-align: center; }
        .login-input { width: 100%; padding: 15px; margin: 10px 0; border: 2px solid #eee; border-radius: 12px; font-family: 'Kanit'; outline: none; transition: 0.3s; }
        .login-input:focus { border-color: var(--main); }

        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 25px; }
        .product-card { background: rgba(255,255,255,0.9); border-radius: 20px; overflow: hidden; box-shadow: 0 5px 20px rgba(0,0,0,0.1); transition: 0.4s; position: relative; border: 1px solid rgba(255,255,255,0.5); backdrop-filter: blur(10px); }
        .product-info { padding: 20px; text-align: center; border-top: 1px solid #f1f1f1; background: #fff; }

        @media (max-width: 600px) { 
            .chat-widget { right: 10px; width: calc(100% - 20px); bottom: 90px; }
            .nav-nickname { display: none; }
        }
    </style>
</head>
<body>
    <div class="scrolling-news">
        <div>‚ú® BAOBEI SHOP ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö! ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏•‡∏á‡πÄ‡∏û‡∏µ‡∏¢‡∏ö! | üî• ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ: ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏∏‡πâ‡∏ô‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÉ‡∏´‡∏ç‡πà! | ‚ö†Ô∏è ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏°‡∏¥‡∏à‡∏â‡∏≤‡∏ä‡∏µ‡∏û ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÉ‡∏ä‡πâ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ä‡∏∑‡πà‡∏≠ ‡∏à‡∏¥‡∏ï‡∏£‡∏≤‡∏†‡∏£‡∏ì‡πå ‡∏à‡∏±‡∏ô‡∏ó‡∏£ ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô! ‚ú®</div>
    </div>

    <canvas id="snowCanvas"></canvas>

    <div id="registerPage" class="hidden">
        <div class="login-card">
            <h2 style="color: var(--main);">CREATE ACCOUNT</h2>
            <input type="text" id="regUsername" class="login-input" placeholder="‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ">
            <input type="password" id="regPassword" class="login-input" placeholder="‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
            <button class="btn-buy" onclick="handleRegister()">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
            <p style="font-size: 14px; margin-top: 15px;">‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß? <a href="#" onclick="toggleAuth('login')" style="color: var(--main); text-decoration: none; font-weight: 500;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</a></p>
        </div>
    </div>

    <div id="loginPage">
        <div class="login-card">
            <h2 style="color: var(--main);">BAOBEI LOGIN</h2>
            <input type="text" id="loginUsername" class="login-input" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ">
            <input type="password" id="loginPassword" class="login-input" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
            <button class="btn-buy" onclick="handleLogin()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            <p style="font-size: 14px; margin-top: 15px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ? <a href="#" onclick="toggleAuth('register')" style="color: var(--main); text-decoration: none; font-weight: 500;">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</a></p>
        </div>
    </div>

    <div id="shopContent" class="hidden">
        <div class="announcement">‚ú® ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà BAOBEI SHOP | ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏î‡∏π‡πÅ‡∏• 24 ‡∏ä‡∏°. ‚ú®</div>
        <nav class="navbar">
            <div class="logo" onclick="showPage('home')">BAOBEI SHOP</div>
            <div class="nav-right">
                <div class="user-profile-btn" onclick="openEditProfile()">
                    <img id="navAvatarImg" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" class="nav-avatar">
                    <span id="navNickname" class="nav-nickname">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</span>
                </div>
                
                <div class="cart-tag" onclick="showCart()">
                    <i class="fas fa-shopping-cart"></i> 
                    <span class="cart-count" id="cartCount">0</span>
                </div>
                <button id="adminBtn" class="btn-admin" onclick="openAdminPanel()">
                    <i class="fas fa-user-shield"></i>
                </button>
                <div class="balance-tag" onclick="showPage('topup')">
                    <i class="fas fa-wallet"></i> <span id="balanceDisplay">0</span> ‡∏ø
                </div>
                <a href="#" onclick="handleLogout()" class="btn-contact"><i class="fas fa-sign-out-alt"></i></a>
            </div>
        </nav>

        <div class="container">
            <div id="homePage">
                <div class="banner-container"><img src="https://lh3.googleusercontent.com/d/1ALVIB9eXw_BXz1By7UBemWyY_0Gp-YoF" class="banner-img"></div>
                <div class="stats-grid">
                    <div class="stat-box"><div class="stat-label">‡∏™‡∏ï‡πá‡∏≠‡∏Å</div><div class="stat-value"><span id="statStock">0</span></div></div>
                    <div class="stat-box"><div class="stat-label">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</div><div class="stat-value"><span id="statUsers">703</span></div></div>
                    <div class="stat-box"><div class="stat-label">‡∏ö‡∏¥‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div><div class="stat-value"><span id="statSalesTotal">1089</span></div></div>
                    <div class="stat-box"><div class="stat-label">‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô</div><div class="stat-value"><span id="statTopupTotal">0</span></div></div>
                </div>
                <div class="title-bar">
                    <h2><i class="fas fa-shopping-bag"></i> ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</h2>
                    <button class="btn-history" onclick="showOrderHistory()"><i class="fas fa-history"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠</button>
                </div>
                <div id="productList" class="product-grid"></div>
            </div>

            <div id="topupPage" class="hidden">
                <div class="topup-card">
                    <h3><i class="fas fa-university"></i> ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô</h3>
                    <div class="qr-section">
                        <p>KKP: <b>201-201-9014</b></p>
                        <p>Wallet: <b>080-920-0932</b></p>
                        <p>‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: ‡∏à‡∏¥‡∏ï‡∏£‡∏≤‡∏†‡∏£‡∏ì‡πå ‡∏à‡∏±‡∏ô‡∏ó‡∏£</p>
                    </div>
                    <input type="number" id="topupAmount" class="login-input" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô">
                    <input type="file" id="slipInput" class="hidden" onchange="previewSlip(this)">
                    <label for="slipInput" class="btn-buy" style="display:block; background:#666; margin:10px 0;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ</label>
                    <img id="slipPreviewImg" class="slip-preview">
                    <button class="btn-buy" onclick="submitTopup()">‡πÅ‡∏à‡πâ‡∏á‡πÇ‡∏≠‡∏ô</button>
                    <p onclick="showPage('home')" style="cursor:pointer; margin-top:10px; color:#999;">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</p>
                </div>
            </div>
        </div>
    </div>

    <div class="chat-widget" id="chatBox">
        <div class="chat-header">
            <span><i class="fas fa-comments"></i> <span id="chatTitle">Global Chat</span></span>
            <i class="fas fa-times" style="cursor:pointer" onclick="toggleWebChat()"></i>
        </div>
        <div class="chat-tabs">
            <div id="tabGlobal" class="chat-tab active" onclick="setChatMode('global')">‡πÅ‡∏ä‡∏ó‡∏£‡∏ß‡∏°</div>
            <div id="tabPrivate" class="chat-tab" onclick="setChatMode('private')">‡πÅ‡∏ä‡∏ó‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</div>
        </div>
        <div class="chat-messages" id="chatMessages"></div>
        <div style="padding: 10px; border-top: 1px solid #eee; display: flex; gap: 5px; background: #fff;">
            <input type="text" id="chatInput" style="flex:1; border: 1px solid #ddd; padding: 10px 15px; border-radius: 20px; outline:none;" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°...">
            <button onclick="sendChat()" style="background: var(--main); color:white; border:none; width: 40px; height: 40px; border-radius: 50%; cursor:pointer;"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>
    <div class="floating-chat" onclick="toggleWebChat()"><i class="fas fa-comment-dots"></i></div>

    <script>
        const PRODUCTS = [
            { id: 1, name: "email(‡∏ô‡∏≠‡∏Å) ‡∏ï‡∏¥‡∏î‡∏™‡∏¥‡∏ó", price: 10, image: "https://lh3.googleusercontent.com/d/1JdUzWjV-sWQkS6vHCekLb7HN9Uc6g4J7" },
            { id: 2, name: "email(‡∏ô‡∏≠‡∏Å) ‡πÇ‡∏ô‡πÄ‡πÄ‡∏û‡∏Ñ", price: 12, image: "https://lh3.googleusercontent.com/d/1JdUzWjV-sWQkS6vHCekLb7HN9Uc6g4J7" },
            { id: 3, name: "emailThai ‡∏ï‡∏¥‡∏î‡∏™‡∏¥‡∏ó", price: 15, image: "https://lh3.googleusercontent.com/d/1JdUzWjV-sWQkS6vHCekLb7HN9Uc6g4J7" },
            { id: 4, name: "emailThai ‡πÇ‡∏ô‡πÅ‡∏û‡∏Ñ", price: 18, image: "https://lh3.googleusercontent.com/d/1JdUzWjV-sWQkS6vHCekLb7HN9Uc6g4J7" }
        ];

        let state = {
            users: JSON.parse(localStorage.getItem('baobei_users')) || {},
            inventory: JSON.parse(localStorage.getItem('baobei_inv')) || { 1: [], 2: [], 3: [], 4: [] },
            topupRequests: JSON.parse(localStorage.getItem('baobei_requests')) || [],
            usedSlips: JSON.parse(localStorage.getItem('baobei_used_slips')) || [],
            salesCount: parseInt(localStorage.getItem('baobei_sales')) || 1089,
            totalTopupSum: parseFloat(localStorage.getItem('baobei_total_topup')) || 0,
            currentUser: null,
            isAdmin: false,
            isModerator: false, 
            activePrivateUser: null,
            globalMessages: JSON.parse(localStorage.getItem('baobei_global_chat')) || [],
            privateMessages: JSON.parse(localStorage.getItem('baobei_private_chat')) || {},
            chatMode: 'global',
            cart: [],
            moderators: JSON.parse(localStorage.getItem('baobei_mods')) || [] 
        };

        function persist() {
            localStorage.setItem('baobei_users', JSON.stringify(state.users));
            localStorage.setItem('baobei_inv', JSON.stringify(state.inventory));
            localStorage.setItem('baobei_requests', JSON.stringify(state.topupRequests));
            localStorage.setItem('baobei_used_slips', JSON.stringify(state.usedSlips));
            localStorage.setItem('baobei_sales', state.salesCount);
            localStorage.setItem('baobei_total_topup', state.totalTopupSum);
            localStorage.setItem('baobei_global_chat', JSON.stringify(state.globalMessages));
            localStorage.setItem('baobei_private_chat', JSON.stringify(state.privateMessages));
            localStorage.setItem('baobei_mods', JSON.stringify(state.moderators));
        }

        function updateUI() {
            document.getElementById('statSalesTotal').innerText = state.salesCount.toLocaleString();
            document.getElementById('statUsers').innerText = Object.keys(state.users).length;
            document.getElementById('statTopupTotal').innerText = Math.floor(state.totalTopupSum).toLocaleString();
            document.getElementById('statStock').innerText = Object.values(state.inventory).reduce((a, b) => a + b.length, 0);
            
            if (state.currentUser && state.users[state.currentUser]) {
                const user = state.users[state.currentUser];
                document.getElementById('balanceDisplay').innerText = user.balance.toLocaleString();
                document.getElementById('navNickname').innerText = user.nickname || state.currentUser;
                if(user.avatar) document.getElementById('navAvatarImg').src = user.avatar;
                
                if (state.isAdmin || state.moderators.includes(state.currentUser)) {
                    document.getElementById('adminBtn').style.display = "block";
                    state.isModerator = !state.isAdmin;
                }
            }
            
            const list = document.getElementById('productList');
            list.innerHTML = PRODUCTS.map(p => {
                const stock = state.inventory[p.id]?.length || 0;
                return `
                <div class="product-card">
                    <div class="stock-tag">${stock > 0 ? '‡∏™‡∏ï‡πá‡∏≠‡∏Å: ' + stock : '‡∏´‡∏°‡∏î'}</div>
                    <img src="${p.image}" class="product-img" loading="lazy">
                    <div class="product-info">
                        <div class="product-name">${p.name}</div>
                        <div class="product-price">${p.price} ‡∏ø</div>
                        <button class="btn-buy" onclick="buyProduct(${p.id})" ${stock === 0 && !state.isAdmin ? 'disabled' : ''}>‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</button>
                        <button class="btn-add-cart" onclick="addToCart(${p.id})" ${stock === 0 ? 'style="display:none"' : ''}><i class="fas fa-cart-plus"></i> ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</button>
                    </div>
                </div>`;
            }).join('');
            renderChat();
        }

        /* ‡∏£‡∏∞‡∏ö‡∏ö Profile */
        function openEditProfile() {
            const user = state.users[state.currentUser];
            if(!user) return;
            Swal.fire({
                title: '‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô',
                html: `
                    <div style="text-align:center;">
                        <img id="editProfilePreview" src="${user.avatar || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'}" style="width:100px; height:100px; border-radius:50%; object-fit:cover; margin-bottom:15px; border:3px solid var(--main);">
                        <br>
                        <label class="btn-history" style="cursor:pointer; padding: 5px 10px;">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ <input type="file" id="profilePicInput" hidden onchange="previewProfileEdit(this)"></label>
                        <input type="text" id="editNickname" class="login-input" value="${user.nickname || ''}" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô">
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å'
            }).then((res) => {
                if (res.isConfirmed) {
                    state.users[state.currentUser].nickname = document.getElementById('editNickname').value;
                    state.users[state.currentUser].avatar = document.getElementById('editProfilePreview').src;
                    persist(); updateUI();
                    Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡πâ‡∏ß', 'success');
                }
            });
        }

        function previewProfileEdit(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => { document.getElementById('editProfilePreview').src = e.target.result; };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function showPublicProfile(uid) {
            const user = (uid === "Admin") ? { nickname: "Admin", avatar: "https://cdn-icons-png.flaticon.com/512/149/149071.png", orders: [] } : state.users[uid];
            if (!user) return;
            Swal.fire({
                title: user.nickname || uid,
                html: `<img src="${user.avatar || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'}" style="width:100px; height:100px; border-radius:50%; object-fit:cover; border:3px solid var(--main);">
                       <p style="margin-top:10px; color:#888;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${state.moderators.includes(uid) ? '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•' : (uid === 'Admin' ? '‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô' : '‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å')}</p>`,
                showConfirmButton: false
            });
        }

        /* ‡∏£‡∏∞‡∏ö‡∏ö Chat ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡∏°‡πà */
        function toggleWebChat() { document.getElementById('chatBox').classList.toggle('active'); }
        
        function setChatMode(mode) {
            state.chatMode = mode;
            document.getElementById('tabGlobal').classList.toggle('active', mode === 'global');
            document.getElementById('tabPrivate').classList.toggle('active', mode === 'private');
            document.getElementById('chatTitle').innerText = (mode === 'global') ? "Global Chat" : "Private Chat";
            renderChat();
        }

        function sendChat() {
            const inp = document.getElementById('chatInput');
            if(!inp.value.trim()) return;
            
            const msg = { 
                userId: state.currentUser,
                text: inp.value, 
                time: Date.now(), 
                isAdmin: (state.isAdmin || state.isModerator) 
            };

            if(state.chatMode === 'global') state.globalMessages.push(msg);
            else {
                let target = (state.isAdmin || state.isModerator) ? state.activePrivateUser : state.currentUser;
                if(!target) return Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô','‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏π‡πà‡∏™‡∏ô‡∏ó‡∏ô‡∏≤','info');
                if(!state.privateMessages[target]) state.privateMessages[target] = [];
                state.privateMessages[target].push(msg);
            }
            persist(); renderChat(); inp.value = "";
        }

        function renderChat() {
            const chatBox = document.getElementById('chatMessages');
            chatBox.innerHTML = "";
            let messages = (state.chatMode === 'global') ? state.globalMessages : (state.privateMessages[(state.isAdmin || state.isModerator) ? state.activePrivateUser : state.currentUser] || []);
            
            messages.forEach(m => {
                const isMe = m.userId === state.currentUser;
                const senderData = (m.userId === 'Admin') ? { nickname: 'Admin', avatar: 'https://cdn-icons-png.flaticon.com/512/149/149071.png' } : (state.users[m.userId] || { nickname: m.userId, avatar: null });
                
                const row = document.createElement('div');
                row.className = `chat-row ${isMe ? 'me' : 'other'}`;
                
                row.innerHTML = `
                    <img src="${senderData.avatar || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'}" class="chat-msg-avatar" onclick="showPublicProfile('${m.userId}')">
                    <div class="chat-msg-body">
                        <span class="chat-msg-name" onclick="showPublicProfile('${m.userId}')">
                            ${m.isAdmin ? '<i class="fas fa-crown badge-crown"></i>' : ''}${senderData.nickname || m.userId}
                        </span>
                        <div class="chat-msg-text">${m.text}</div>
                    </div>
                `;
                chatBox.appendChild(row);
            });
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        /* Auth & Shop Logic (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏∏‡∏ì) */
        function toggleAuth(type) {
            document.getElementById('loginPage').classList.toggle('hidden', type !== 'login');
            document.getElementById('registerPage').classList.toggle('hidden', type !== 'register');
        }

        function handleRegister() {
            const u = document.getElementById('regUsername').value.trim();
            const p = document.getElementById('regPassword').value.trim();
            if(!u || !p) return;
            state.users[u] = { password: p, balance: 0, orders: [], nickname: u, avatar: null }; 
            persist(); toggleAuth('login');
        }

        function handleLogin() {
            const u = document.getElementById('loginUsername').value.trim();
            const p = document.getElementById('loginPassword').value.trim();
            if(u.toLowerCase() === 'admin' && p === 'yongchai07') {
                state.currentUser = "Admin"; state.isAdmin = true;
            } else if(state.users[u] && state.users[u].password === p) {
                state.currentUser = u;
            } else { return Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î','‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á','error'); }
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('shopContent').classList.remove('hidden');
            updateUI();
        }

        function handleLogout() { location.reload(); }
        function showPage(p) {
            document.getElementById('homePage').classList.toggle('hidden', p !== 'home');
            document.getElementById('topupPage').classList.toggle('hidden', p !== 'topup');
        }

        /* 8. SNOW EFFECT */
        const canvas = document.getElementById('snowCanvas');
        const ctx = canvas.getContext('2d');
        let width, height, flakes = [];
        function initSnow() { width = window.innerWidth; height = window.innerHeight; canvas.width = width; canvas.height = height; flakes = Array.from({length: 50}, () => ({ x: Math.random() * width, y: Math.random() * height, r: Math.random() * 3 + 1, d: Math.random() * 1 + 0.5 })); }
        function drawSnow() { ctx.clearRect(0, 0, width, height); ctx.fillStyle = "white"; ctx.beginPath(); flakes.forEach(f => { ctx.moveTo(f.x, f.y); ctx.arc(f.x, f.y, f.r, 0, Math.PI * 2); }); ctx.fill(); flakes.forEach(f => { f.y += f.d; if (f.y > height) f.y = -10; }); requestAnimationFrame(drawSnow); }
        window.addEventListener('resize', initSnow); initSnow(); drawSnow(); updateUI();
    </script>
</body>
</html>
